<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ø·Ù„ ØªØ¹Ø±ÙŠØµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #f43f5e;
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            color: #f8fafc;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .glass-card {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }
        .btn-primary {
            background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);
            transition: transform 0.2s;
        }
        .btn-primary:active {
            transform: scale(0.95);
        }
        .screen {
            display: none;
            min-height: 100vh;
            padding: 2rem 1.5rem 5rem 1.5rem;
            animation: fadeIn 0.4s ease-out;
        }
        .screen.active {
            display: flex;
            flex-direction: column;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .countdown-number {
            font-size: 8rem;
            font-weight: 900;
            color: var(--primary);
            text-shadow: 0 0 20px rgba(244, 63, 94, 0.5);
            animation: pulseScale 1s infinite;
        }
        @keyframes pulseScale {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        input, textarea {
            background: #334155;
            border: 2px solid transparent;
            color: white;
            transition: border-color 0.3s;
        }
        input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .footer-note {
            position: fixed;
            bottom: 1rem;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.75rem;
            opacity: 0.6;
            pointer-events: none;
        }
        .category-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }
    </style>
</head>
<body>

    <!-- 1. Welcome Screen -->
    <div id="welcome-screen" class="screen active justify-center items-center">
        <div class="text-center">
            <h1 class="text-6xl font-black mb-4 text-rose-500 tracking-tighter">Ø¨Ø·Ù„ ØªØ¹Ø±ÙŠØµ</h1>
            <p class="text-slate-400 text-lg mb-12">Ù„Ø¹Ø¨Ø© Ø§Ù„Ù‚ÙØ´ ÙˆØ§Ù„Ø°ÙƒØ§Ø¡</p>
            <button onclick="navigateTo('setup-screen')" class="btn-primary w-64 py-4 rounded-full text-xl font-bold shadow-lg">
                ÙŠÙ„Ø§ Ù†Ù„Ø¹Ø¨
            </button>
        </div>
    </div>

    <!-- 2. Player Setup Screen -->
    <div id="setup-screen" class="screen">
        <h2 class="text-3xl font-bold mb-6 text-center">Ù…ÙŠÙ† Ù‡ÙŠÙ„Ø¹Ø¨ØŸ</h2>
        <div class="glass-card p-6 flex-grow mb-6">
            <label class="block mb-2 text-slate-400">Ø§ÙƒØªØ¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø¹ÙŠØ¨Ø© (ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø±)</label>
            <textarea id="player-names" class="w-full h-64 p-4 rounded-xl resize-none text-lg" placeholder="Ø£Ø­Ù…Ø¯&#10;Ø³Ø§Ø±Ø©&#10;Ù…Ø­Ù…Ø¯..."></textarea>
        </div>
        <button onclick="savePlayers()" class="btn-primary w-full py-4 rounded-full text-xl font-bold">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    </div>

    <!-- 3. Category Selection -->
    <div id="category-screen" class="screen">
        <h2 class="text-3xl font-bold mb-6 text-center">Ø§Ø®ØªØ§Ø± Ø§Ù„ÙØ¦Ø©</h2>
        <div id="categories-list" class="grid grid-cols-2 gap-4 flex-grow overflow-y-auto">
            <!-- Dynamic Categories -->
        </div>
        <button onclick="navigateTo('setup-screen')" class="mt-4 text-slate-400 font-bold">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
    </div>

    <!-- 4. Role Reveal -->
    <div id="reveal-screen" class="screen justify-center">
        <div id="reveal-card" class="glass-card p-8 text-center py-16">
            <h3 id="current-player-name" class="text-2xl font-bold mb-4 text-rose-400">...</h3>
            <p class="mb-8 text-slate-300">Ø¯ÙˆØ³ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø¯ÙˆØ±Ùƒ Ù„ÙˆØ­Ø¯Ùƒ</p>
            
            <div id="role-box" class="hidden mb-8">
                <div id="role-badge" class="inline-block px-6 py-2 rounded-full bg-rose-500 text-white font-bold mb-4"></div>
                <h4 id="secret-word-display" class="text-4xl font-black text-white"></h4>
            </div>

            <button id="toggle-role-btn" onclick="toggleRole()" class="bg-slate-700 hover:bg-slate-600 w-full py-4 rounded-xl text-lg font-bold transition-all">
                Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯ÙˆØ±
            </button>
            <button id="next-player-btn" onclick="nextPlayer()" class="hidden btn-primary w-full py-4 rounded-xl text-lg font-bold mt-4">
                ØªÙ… .. Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡
            </button>
        </div>
    </div>

    <!-- 5. Investigation Phase -->
    <div id="timer-screen" class="screen items-center">
        <h2 class="text-2xl font-bold mb-8 text-center">Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ Ø´ØºØ§Ù„.. Ù…ÙŠÙ† "Ø§Ù„Ø¹Ø±Øµ"ØŸ</h2>
        <div class="flex-grow flex items-center justify-center">
            <div id="countdown-timer" class="text-7xl font-black text-rose-500 font-mono">03:00</div>
        </div>
        <button onclick="startVoting()" class="btn-primary w-full py-4 rounded-full text-xl font-bold shadow-lg mt-8">
            Ø¹Ø±ÙÙ†Ø§ Ù…ÙŠÙ† Ø§Ù„Ø¬Ø§Ø³ÙˆØ³
        </button>
    </div>

    <!-- 6. Voting Screen -->
    <div id="voting-screen" class="screen">
        <h2 class="text-3xl font-bold mb-6 text-center">Ù…ÙŠÙ† Ø´Ø§ÙƒÙƒ ÙÙŠÙ‡ØŸ</h2>
        <div id="voters-container" class="space-y-4 flex-grow overflow-y-auto pb-4">
            <!-- Dynamic Voting List -->
        </div>
        <button id="submit-votes-btn" onclick="processVoting()" class="btn-primary w-full py-4 rounded-full text-xl font-bold mt-4">
            ÙƒØ´Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©
        </button>
    </div>

    <!-- 7. Dramatic Reveal Animation -->
    <div id="drama-screen" class="screen justify-center items-center bg-black">
        <div id="drama-timer" class="countdown-number">3</div>
    </div>

    <!-- 8. Result & Final Guess -->
    <div id="result-screen" class="screen">
        <div class="glass-card p-8 text-center mb-6">
            <h2 class="text-2xl mb-2 text-slate-400">Ø§Ù„Ø¹Ø±Øµ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù‡Ùˆ:</h2>
            <h1 id="actual-spy-name" class="text-5xl font-black text-rose-500 mb-6"></h1>
            <p id="voting-summary" class="text-slate-300 italic"></p>
        </div>

        <div id="spy-guess-section" class="glass-card p-6">
            <h3 class="text-xl font-bold mb-4">Ø³Ø¤Ø§Ù„ Ù„Ù„Ø¹Ø±Øµ: Ø§Ù„ÙƒÙ„Ù…Ø© ÙƒØ§Ù†Øª Ø¥ÙŠÙ‡ØŸ</h3>
            <div id="guess-options" class="grid grid-cols-1 gap-3">
                <!-- Multi-choice options -->
            </div>
        </div>

        <div id="final-verdict" class="hidden glass-card p-8 text-center mt-6">
            <h2 id="verdict-title" class="text-3xl font-bold mb-2"></h2>
            <p id="verdict-msg" class="text-lg mb-6"></p>
            <div class="space-y-4">
                <button onclick="startNewRoundSamePlayers()" class="btn-primary w-full py-4 rounded-full text-xl font-bold">
                    Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¯ÙˆØ± (Ù†ÙØ³ Ø§Ù„Ù„Ø¹ÙŠØ¨Ø©)
                </button>
                <button onclick="resetGame()" class="bg-slate-700 w-full py-4 rounded-full text-xl font-bold">
                    Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø© ØªÙ…Ø§Ù…Ø§Ù‹
                </button>
            </div>
        </div>
    </div>

    <div class="footer-note">Â© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¯Ù‰ HOMOS</div>

    <script>
        const CATEGORY_DATA = {
            "Ù…Ù„Ø§Ø¨Ø³": { icon: "ğŸ‘•", words: ["Ù‚Ù…ÙŠØµ", "Ø¨Ù†Ø·Ù„ÙˆÙ†", "ÙØ³ØªØ§Ù†", "Ø¨Ø¯Ù„Ø©", "Ø¬Ø±Ø§ÙÙŠØªØ©", "Ø´Ø±Ø§Ø¨", "ÙƒÙˆØªØ´ÙŠ", "Ø·Ø§Ù‚ÙŠØ©", "Ø¬Ø§ÙƒÙŠØª", "Ø¨Ù„ÙˆÙØ±", "Ø´ÙˆØ±Øª", "Ø·Ø±Ø­Ø©", "Ø®Ù…Ø§Ø±", "Ù…Ø§ÙŠÙˆÙ‡", "Ø¨ÙŠØ¬Ø§Ù…Ø©", "ÙƒÙ„Ø³ÙˆÙ†", "Ø¹Ø¨Ø§ÙŠØ©", "ØªÙŠØ´ÙŠØ±Øª", "Ø´Ø§Ù„", "Ù‚ÙØ§Ø²Ø§Øª", "Ø¨Ø±Ù†ÙŠØ·Ø©", "Ø¨ÙˆØª", "ØµÙ†Ø¯Ù„", "Ø­Ø²Ø§Ù…", "Ø¨Ø¨ÙŠÙˆÙ†Ø©"] },
            "Ø·Ø¹Ø§Ù…": { icon: "ğŸ”", words: ["ÙƒØ´Ø±ÙŠ", "Ù…Ù„ÙˆØ®ÙŠØ©", "Ù…Ø­Ø´ÙŠ", "Ø¨ÙŠØªØ²Ø§", "Ø¨Ø±Ø¬Ø±", "Ø´Ø§ÙˆØ±Ù…Ø§", "Ø­ÙˆØ§ÙˆØ´ÙŠ", "ÙØªØ©", "Ø¨Ø§Ù…ÙŠØ©", "Ù…Ù…Ø¨Ø§Ø±", "ÙƒÙØªØ©", "Ø·Ø¹Ù…ÙŠØ©", "ÙÙˆÙ„", "Ø±Ù†Ø¬Ø©", "ÙØ³ÙŠØ®", "ÙƒØ¨Ø¯Ø©", "Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ø´Ø§Ù…ÙŠÙ„", "Ø£Ø±Ø² Ø¨Ù„Ø¨Ù†", "ÙƒÙ†Ø§ÙØ©", "Ø¨Ø³Ø¨ÙˆØ³Ø©", "Ù‚Ø·Ø§ÙŠÙ", "Ø­Ù…Ø§Ù… Ù…Ø­Ø´ÙŠ", "Ø³Ù…Ùƒ Ù…Ø´ÙˆÙŠ", "Ù…Ø³Ù‚Ø¹Ø©", "Ù…Ù†Ø¯ÙŠ"] },
            "Ù…Ø´Ø±ÙˆØ¨Ø§Øª": { icon: "ğŸ¥¤", words: ["Ù…Ø§Ù†Ø¬Ùˆ", "Ù‚ØµØ¨", "ØªÙ…Ø± Ù‡Ù†Ø¯ÙŠ", "Ø³ÙˆØ¨ÙŠØ§", "Ø®Ø±ÙˆØ¨", "Ø¹Ø±Ù‚Ø³ÙˆØ³", "Ø´Ø§ÙŠ", "Ù‚Ù‡ÙˆØ©", "Ù†Ø³ÙƒØ§ÙÙŠÙ‡", "Ø¨ÙŠØ¨Ø³ÙŠ", "Ø¹ØµÙŠØ± Ù‚ØµØ¨", "ÙƒØ±ÙƒØ¯ÙŠÙ‡", "ÙŠÙ†Ø³ÙˆÙ†", "Ù†Ø¹Ù†Ø§Ø¹", "Ù„ÙŠÙ…ÙˆÙ† Ø¨Ø§Ù„Ù†Ø¹Ù†Ø§Ø¹", "ÙØ±Ø§Ø¨ØªØ´ÙŠÙ†Ùˆ", "Ø³Ù…ÙˆØ²ÙŠ", "Ø¢ÙŠØ³ ØªÙŠ", "Ù‚Ø±ÙØ©", "Ø³Ø­Ù„Ø¨", "ÙƒØ§ÙƒØ§Ùˆ", "Ù„Ø¨Ù†", "Ù…ÙŠØ±Ù†Ø¯Ø§", "Ø³Ø¨Ø±Ø§ÙŠØª", "Ø¹ØµÙŠØ± Ø¨Ø±ØªÙ‚Ø§Ù„"] },
            "Ù„Ø§Ø¹Ø¨ÙŠÙ†": { icon: "âš½", words: ["Ù…Ø­Ù…Ø¯ ØµÙ„Ø§Ø­", "Ù…ÙŠØ³ÙŠ", "Ø±ÙˆÙ†Ø§Ù„Ø¯Ùˆ", "Ø£Ø¨Ùˆ ØªØ±ÙŠÙƒØ©", "Ù…Ø¬Ø¯ÙŠ Ø£ÙØ´Ø©", "Ø²ÙŠØ²Ùˆ", "Ø´ÙŠÙƒØ§Ø¨Ø§Ù„Ø§", "Ù…Ø¨Ø§Ø¨ÙŠ", "Ù‡Ø§Ù„Ø§Ù†Ø¯", "Ù†ÙŠÙ…Ø§Ø±", "Ø¨Ù†Ø²ÙŠÙ…Ø§", "Ø§Ù„Ø´Ù†Ø§ÙˆÙŠ", "Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø§Ù„Ø³Ø¹ÙŠØ¯", "ØµØ§Ù„Ø­ Ø¬Ù…Ø¹Ø©", "Ø­Ø³Ø§Ù… ØºØ§Ù„ÙŠ", "Ø¨Ø±ÙƒØ§Øª", "Ø²ÙŠØ¯Ø§Ù†", "Ù…ÙˆØ¯Ø±ÙŠØªØ´", "Ø¯ÙŠ Ø¨Ø±ÙˆÙŠÙ†", "Ù„ÙŠÙØ§Ù†Ø¯ÙˆÙØ³ÙƒÙŠ", "ÙÙŠÙ†ÙŠØ³ÙŠÙˆØ³", "Ø¨ÙŠÙ„ÙŠÙ†Ø¬Ù‡Ø§Ù…", "ØµÙ„Ø§Ø­ Ù…Ø­Ø³Ù†", "ÙƒÙ‡Ø±Ø¨Ø§", "Ø¥Ù…Ø§Ù… Ø¹Ø§Ø´ÙˆØ±"] },
            "Ø£Ù…Ø§ÙƒÙ†": { icon: "ğŸ“", words: ["Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©", "Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®", "Ø§Ù„Ø£Ù‡Ø±Ø§Ù…Ø§Øª", "Ø¨Ø±Ø¬ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯", "Ø§Ù„Ø­Ø³ÙŠÙ†", "Ø§Ù„Ø¬ÙˆÙ†Ø©", "Ù…Ø·Ø±ÙˆØ­", "Ø§Ù„Ø£Ù‚ØµØ±", "Ø£Ø³ÙˆØ§Ù†", "Ø§Ù„Ù‚Ù„Ø¹Ø©", "Ø­Ø¯ÙŠÙ‚Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†", "Ø§Ù„Ù…ØªØ­Ù Ø§Ù„Ù…ØµØ±ÙŠ", "Ù…ÙˆÙ„ Ù…ØµØ±", "ÙƒØ§ÙŠØ±Ùˆ ÙÙŠØ³ØªÙŠÙØ§Ù„", "Ø§Ù„Ø³Ø§Ø­Ù„ Ø§Ù„Ø´Ù…Ø§Ù„ÙŠ", "Ø¯Ù‡Ø¨", "Ø®Ø§Ù† Ø§Ù„Ø®Ù„ÙŠÙ„ÙŠ", "Ù…ÙŠØ¯Ø§Ù† Ø§Ù„ØªØ­Ø±ÙŠØ±", "Ø§Ù„Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©", "Ø§Ù„Ø³Ø®Ù†Ø©", "Ø³ÙŠÙ†Ø§Ø¡", "Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯", "Ø·Ù†Ø·Ø§"] },
            "Ø£ÙÙ„Ø§Ù…": { icon: "ğŸ¬", words: ["Ø§Ù„ÙÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ù‚", "ØªÙŠØªÙˆ", "ÙƒØ±Ø§ÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ø´Ø§Ø±Ø¹", "Ø§Ù„Ù„Ù…Ø¨ÙŠ", "Ø¹Ø³Ù„ Ø£Ø³ÙˆØ¯", "Ø§Ù„Ù†Ø§ØµØ± ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†", "Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±", "Ù…Ø§ ÙˆØ±Ø§Ø¡ Ø§Ù„Ø·Ø¨ÙŠØ¹Ø©", "Ø§Ù„Ù„Ø¹Ø¨Ø©", "Ø§Ù„ÙƒØ¨ÙŠØ± Ø£ÙˆÙŠ", "Ø¬Ø¹ÙØ± Ø§Ù„Ø¹Ù…Ø¯Ø©", "Ø³ÙØ§Ø­ Ø§Ù„Ø¬ÙŠØ²Ø©", "Ø§Ù„Ø­Ø±ÙŠÙØ©", "ÙˆÙ„Ø§Ø¯ Ø±Ø²Ù‚", "Ø§Ù„Ø¬Ø²ÙŠØ±Ø©", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø£Ø¨ÙŠØ¶", "Ø·ÙŠÙˆØ± Ø§Ù„Ø¸Ù„Ø§Ù…", "Ø¹ÙˆØ§Ù„Ù… Ø®ÙÙŠØ©", "Ø±Ø£ÙØª Ø§Ù„Ù‡Ø¬Ø§Ù†", "Ù„ÙŠØ§Ù„ÙŠ Ø§Ù„Ø­Ù„Ù…ÙŠØ©", "Ø§Ù„Ø¨Ø®ÙŠÙ„ ÙˆØ£Ù†Ø§", "Ù„Ù† Ø£Ø¹ÙŠØ´ ÙÙŠ Ø¬Ù„Ø¨Ø§Ø¨ Ø£Ø¨ÙŠ", "Ù‡Ø±ÙˆØ¨ Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ", "ÙƒØ§Ø²Ø§Ø¨Ù„Ø§Ù†ÙƒØ§", "Ø§Ù„Ù…Ù…Ø±"] }
        };

        let gameState = {
            players: [],
            category: "",
            secretWord: "",
            spyIndex: -1,
            currentPlayerReveal: 0,
            timer: 180,
            timerId: null,
            votes: {},
            gameStartTime: null
        };

        const APP_ID = "homos_game_btl_tr3is_v2";
        
        function saveToStorage() {
            gameState.gameStartTime = Date.now();
            localStorage.setItem(APP_ID, JSON.stringify(gameState));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem(APP_ID);
            if (saved) {
                const parsed = JSON.parse(saved);
                if (Date.now() - parsed.gameStartTime < 300000) {
                    gameState = parsed;
                    if (gameState.players.length > 0) {
                        document.getElementById('player-names').value = gameState.players.join('\n');
                    }
                }
            }
        }

        function navigateTo(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            window.scrollTo(0, 0);
        }

        function savePlayers() {
            const input = document.getElementById('player-names').value.trim();
            if (!input) return;
            gameState.players = input.split('\n').map(n => n.trim()).filter(n => n !== "");
            if (gameState.players.length < 3) {
                alert("Ù„Ø§Ø²Ù… 3 Ù„Ø¹ÙŠØ¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!");
                return;
            }
            renderCategories();
            navigateTo('category-screen');
            saveToStorage();
        }

        function renderCategories() {
            const container = document.getElementById('categories-list');
            container.innerHTML = '';
            Object.entries(CATEGORY_DATA).forEach(([name, data]) => {
                const btn = document.createElement('button');
                btn.className = "glass-card p-4 text-lg font-bold hover:bg-rose-500/20 transition-all border-2 border-transparent hover:border-rose-500";
                btn.innerHTML = `
                    <span class="category-icon">${data.icon}</span>
                    <span>${name}</span>
                `;
                btn.onclick = () => selectCategory(name);
                container.appendChild(btn);
            });
        }

        function selectCategory(cat) {
            gameState.category = cat;
            const words = CATEGORY_DATA[cat].words;
            gameState.secretWord = words[Math.floor(Math.random() * words.length)];
            gameState.spyIndex = Math.floor(Math.random() * gameState.players.length);
            gameState.currentPlayerReveal = 0;
            gameState.votes = {};
            
            initReveal();
            navigateTo('reveal-screen');
            saveToStorage();
        }

        function initReveal() {
            const player = gameState.players[gameState.currentPlayerReveal];
            document.getElementById('current-player-name').innerText = player;
            document.getElementById('role-box').classList.add('hidden');
            document.getElementById('toggle-role-btn').classList.remove('hidden');
            document.getElementById('next-player-btn').classList.add('hidden');
        }

        function toggleRole() {
            const isSpy = gameState.currentPlayerReveal === gameState.spyIndex;
            const badge = document.getElementById('role-badge');
            const wordDisplay = document.getElementById('secret-word-display');
            
            if (isSpy) {
                badge.innerText = "Ø£Ù†Øª Ø§Ù„Ø¹Ø±Øµ";
                wordDisplay.innerText = "ğŸ”’ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
            } else {
                badge.innerText = "Ø£Ù†Øª Ø¨Ø±Ø¦";
                wordDisplay.innerText = gameState.secretWord;
            }

            document.getElementById('role-box').classList.remove('hidden');
            document.getElementById('toggle-role-btn').classList.add('hidden');
            document.getElementById('next-player-btn').classList.remove('hidden');
        }

        function nextPlayer() {
            gameState.currentPlayerReveal++;
            if (gameState.currentPlayerReveal < gameState.players.length) {
                initReveal();
                saveToStorage();
            } else {
                startTimer();
                navigateTo('timer-screen');
            }
        }

        function startTimer() {
            gameState.timer = 180;
            updateTimerUI();
            if (gameState.timerId) clearInterval(gameState.timerId);
            gameState.timerId = setInterval(() => {
                gameState.timer--;
                updateTimerUI();
                if (gameState.timer <= 0) {
                    clearInterval(gameState.timerId);
                    startVoting();
                }
            }, 1000);
        }

        function updateTimerUI() {
            const mins = Math.floor(gameState.timer / 60);
            const secs = gameState.timer % 60;
            document.getElementById('countdown-timer').innerText = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function startVoting() {
            clearInterval(gameState.timerId);
            const container = document.getElementById('voters-container');
            container.innerHTML = '';
            
            gameState.players.forEach((p, idx) => {
                const card = document.createElement('div');
                card.className = "glass-card p-4";
                card.innerHTML = `
                    <p class="mb-3 text-rose-400 font-bold">${p} Ø´Ø§ÙƒÙƒ ÙÙŠ Ù…ÙŠÙ†ØŸ</p>
                    <div class="grid grid-cols-2 gap-2">
                        ${gameState.players.map((target, tIdx) => 
                            `<button onclick="setVote(${idx}, ${tIdx})" id="v-${idx}-${tIdx}" class="vote-btn p-2 rounded-lg bg-slate-700 text-sm">
                                ${target}
                            </button>`
                        ).join('')}
                    </div>
                `;
                container.appendChild(card);
            });
            navigateTo('voting-screen');
        }

        function setVote(voterIdx, targetIdx) {
            gameState.votes[voterIdx] = targetIdx;
            document.querySelectorAll(`[id^="v-${voterIdx}-"]`).forEach(b => b.classList.replace('bg-rose-500', 'bg-slate-700'));
            document.getElementById(`v-${voterIdx}-${targetIdx}`).classList.replace('bg-slate-700', 'bg-rose-500');
            saveToStorage();
        }

        function processVoting() {
            if (Object.keys(gameState.votes).length < gameState.players.length) {
                alert("Ù„Ø§Ø²Ù… Ø§Ù„ÙƒÙ„ ÙŠØ®ØªØ§Ø±!");
                return;
            }
            startDrama();
        }

        function startDrama() {
            navigateTo('drama-screen');
            let count = 3;
            document.getElementById('drama-timer').innerText = count;
            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    document.getElementById('drama-timer').innerText = count;
                } else {
                    clearInterval(interval);
                    showResults();
                }
            }, 1000);
        }

        function showResults() {
            const spyName = gameState.players[gameState.spyIndex];
            document.getElementById('actual-spy-name').innerText = spyName;
            
            let spyVotes = 0;
            Object.values(gameState.votes).forEach(v => { if(v === gameState.spyIndex) spyVotes++; });
            document.getElementById('voting-summary').innerText = `${spyVotes} Ù…Ù† ${gameState.players.length} Ù„Ø¹ÙŠØ¨Ø© Ù‚ÙØ´ÙˆØ§ Ø§Ù„Ø¹Ø±Øµ!`;

            const optionsContainer = document.getElementById('guess-options');
            optionsContainer.innerHTML = '';
            
            let options = [gameState.secretWord];
            const allWords = CATEGORY_DATA[gameState.category].words;
            while(options.length < 4) {
                const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
                if (!options.includes(randomWord)) options.push(randomWord);
            }
            options.sort(() => Math.random() - 0.5);

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "bg-slate-700 p-4 rounded-xl text-lg font-bold hover:bg-slate-600";
                btn.innerText = opt;
                btn.onclick = () => checkSpyGuess(opt);
                optionsContainer.appendChild(btn);
            });

            document.getElementById('spy-guess-section').classList.remove('hidden');
            document.getElementById('final-verdict').classList.add('hidden');
            navigateTo('result-screen');
        }

        function checkSpyGuess(guessedWord) {
            const isCorrect = guessedWord === gameState.secretWord;
            const verdict = document.getElementById('final-verdict');
            const title = document.getElementById('verdict-title');
            const msg = document.getElementById('verdict-msg');

            verdict.classList.remove('hidden');
            document.getElementById('spy-guess-section').classList.add('hidden');

            if (isCorrect) {
                title.innerText = "Ø§Ù„Ø¹Ø±Øµ ÙƒØ³Ø¨! ğŸ”¥";
                title.className = "text-3xl font-bold mb-2 text-green-400";
                msg.innerText = "Ø¹Ø±Ù ÙŠØ®Ù„Ø¹! Ø±ØºÙ… Ø¥Ù†ÙƒÙ… Ù‚ÙØ´ØªÙˆÙ‡ Ø¨Ø³ Ù‡Ùˆ Ø¹Ø±Ù Ø§Ù„ÙƒÙ„Ù…Ø© ÙÙŠ Ø§Ù„Ø¢Ø®Ø±.";
            } else {
                title.innerText = "Ø§Ù„Ø¹Ø±Øµ Ø®Ø³Ø±! ğŸ¤¡";
                title.className = "text-3xl font-bold mb-2 text-rose-500";
                msg.innerText = `Ø§Ù„ÙƒÙ„Ù…Ø© ÙƒØ§Ù†Øª "${gameState.secretWord}".. Ø§Ù„Ø¹Ø±Øµ Ø§ØªÙƒØ´Ù ÙˆØ·Ù„Ø¹ Ø¨Ù„Ø­!`;
            }
        }

        // Feature: Start new round with same players
        function startNewRoundSamePlayers() {
            renderCategories();
            navigateTo('category-screen');
        }

        function resetGame() {
            localStorage.removeItem(APP_ID);
            location.reload();
        }

        window.onload = loadFromStorage;
    </script>
</body>
</html>

