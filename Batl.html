<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ø·Ù„ ØªØ¹Ø±ÙŠØµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: white;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        .animate-pop {
            animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes pop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .gradient-text {
            background: linear-gradient(to right, #f87171, #facc15);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Card Styles */
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { Users, Eye, EyeOff, Play, Timer, AlertTriangle, CheckCircle, Trophy, RefreshCcw, HelpCircle } = lucideReact;

        // --- WORD DATABASE ---
        const GAME_DATA = {
            "Ø£ÙƒÙ„Ø§Øª Ù…ØµØ±ÙŠØ©": [
                "ÙƒØ´Ø±ÙŠ", "Ù…ÙˆÙ„ÙˆØ®ÙŠØ©", "Ù…Ø­Ø´ÙŠ", "ÙØªØ©", "Ø­ÙˆØ§ÙˆØ´ÙŠ", "ÙÙˆÙ„ ÙˆØ·Ø¹Ù…ÙŠØ©", "Ù…Ø³Ù‚Ø¹Ø©", "ÙƒÙˆØ§Ø±Ø¹", "Ù…Ù…Ø¨Ø§Ø±", "Ø¨ØµØ§Ø±Ø©",
                "Ø±Ù†Ø¬Ø©", "ÙØ³ÙŠØ®", "ÙƒØ¨Ø¯Ø© Ø¥Ø³ÙƒÙ†Ø¯Ø±Ø§Ù†ÙŠ", "Ø´Ø§ÙˆØ±Ù…Ø§", "Ø­Ù…Ø§Ù… Ù…Ø­Ø´ÙŠ", "Ø£Ù… Ø¹Ù„ÙŠ", "Ø¨Ø³Ø¨ÙˆØ³Ø©", "ÙƒÙ†Ø§ÙØ©", "Ø²Ù„Ø§Ø¨ÙŠØ©", "ÙØ·ÙŠØ± Ù…Ø´Ù„ØªØª"
            ],
            "Ù…Ù„Ø§Ø¨Ø³": [
                "Ø¨Ù†Ø·Ù„ÙˆÙ† Ø¬ÙŠÙ†Ø²", "ØªÙŠØ´ÙŠØ±Øª", "Ù‚Ù…ÙŠØµ", "Ø´Ø±Ø§Ø¨", "Ø¨ÙˆÙƒØ³Ø±", "Ø¬Ø²Ù…Ø©", "Ø·Ø§Ù‚ÙŠØ©", "Ø¬Ø§ÙƒÙŠØª", "Ø¨Ø¯Ù„Ø©", "ÙƒØ±Ø§ÙØªØ©",
                "Ø¨ÙŠØ¬Ø§Ù…Ø©", "Ø´Ø¨Ø´Ø¨", "Ø­Ø²Ø§Ù…", "Ø¨Ù„ÙˆÙØ±", "Ù…Ø§ÙŠÙˆÙ‡", "ÙØ³ØªØ§Ù†", "Ø·Ø±Ø­Ø©", "Ø¹Ø¨Ø§ÙŠØ©", "Ø¬ÙˆØ§Ù†ØªÙŠ", "Ø³ÙƒØ§Ø±Ù"
            ],
            "Ù…Ø´Ø±ÙˆØ¨Ø§Øª": [
                "Ø´Ø§ÙŠ", "Ù‚Ù‡ÙˆØ©", "Ù†Ø³ÙƒØ§ÙÙŠØ©", "Ø¹ØµÙŠØ± Ù‚ØµØ¨", "Ø¹ØµÙŠØ± Ù…Ø§Ù†Ø¬Ø©", "Ø³ÙˆØ¨ÙŠØ§", "ØªÙ…Ø± Ù‡Ù†Ø¯ÙŠ", "Ø¨ÙŠØ¨Ø³ÙŠ", "Ù…ÙŠØ§Ø© Ù…Ø¹Ø¯Ù†ÙŠØ©", "ÙŠØ§Ù†Ø³ÙˆÙ†",
                "ÙƒØ±ÙƒØ¯ÙŠØ©", "Ø³Ø­Ù„Ø¨", "Ø­Ù…Øµ Ø§Ù„Ø´Ø§Ù…", "Ù…ÙˆØ² Ø¨Ø§Ù„Ù„Ø¨Ù†", "Ù„ÙŠÙ…ÙˆÙ† Ø¨Ø§Ù„Ù†Ø¹Ù†Ø§Ø¹", "ÙØ±Ø§Ø¨ØªØ´ÙŠÙ†Ùˆ", "Ø§Ø³Ø¨Ø±ÙŠØ³Ùˆ", "Ø´Ø§ÙŠ Ø¨Ù„Ø¨Ù†", "Ø®Ø±ÙˆØ¨", "Ø¹Ø±Ù‚Ø³ÙˆØ³"
            ],
            "Ù„Ø§Ø¹ÙŠØ¨Ø© ÙƒÙˆØ±Ø©": [
                "Ù…Ø­Ù…Ø¯ ØµÙ„Ø§Ø­", "Ù…ÙŠØ³ÙŠ", "ÙƒØ±ÙŠØ³ØªÙŠØ§Ù†Ùˆ", "Ø´ÙŠÙƒØ§Ø¨Ø§Ù„Ø§", "Ø£ÙØ´Ø©", "Ø§Ù„Ø´Ù†Ø§ÙˆÙŠ", "Ø²ÙŠØ²Ùˆ", "Ø£Ø¨Ùˆ ØªØ±ÙŠÙƒØ©", "Ø­Ø§Ø²Ù… Ø¥Ù…Ø§Ù…", "Ø¹Ù…Ø§Ø¯ Ù…ØªØ¹Ø¨",
                "Ø³ÙŠØ¯ Ø¹Ø¨Ø¯ Ø§Ù„Ø­ÙÙŠØ¸", "ÙˆØ§Ø¦Ù„ Ø¬Ù…Ø¹Ø©", "Ø¹ØµØ§Ù… Ø§Ù„Ø­Ø¶Ø±ÙŠ", "Ù†ÙŠÙ…Ø§Ø±", "Ù…Ø¨Ø§Ø¨ÙŠ", "Ù‡Ø§Ù„Ø§Ù†Ø¯", "Ø¯ÙŠ Ø¨Ø±ÙˆÙŠÙ†", "Ù…ÙˆØ¯Ø±ÙŠØªØ´", "Ø¨Ù†Ø²ÙŠÙ…Ø©", "Ù„ÙŠÙØ§Ù†Ø¯ÙˆÙØ³ÙƒÙŠ"
            ],
            "Ø£Ù…Ø§ÙƒÙ†": [
                "Ø§Ù„Ø£Ù‡Ø±Ø§Ù…Ø§Øª", "Ø¨Ø±Ø¬ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©", "Ø§Ù„Ø³Ø§Ø­Ù„ Ø§Ù„Ø´Ù…Ø§Ù„ÙŠ", "Ø¯Ù‡Ø¨", "Ø´Ø±Ù… Ø§Ù„Ø´ÙŠØ®", "Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©", "Ù…Ø­Ø·Ø© Ø§Ù„Ø±Ù…Ù„", "ÙˆØ³Ø· Ø§Ù„Ø¨Ù„Ø¯", "Ø§Ù„Ø­Ø³ÙŠÙ†", "Ø®Ø§Ù† Ø§Ù„Ø®Ù„ÙŠÙ„ÙŠ",
                "Ù…ÙˆÙ„ Ù…ØµØ±", "Ø³ÙŠØªÙŠ Ø³ØªØ§Ø±Ø²", "Ø§Ù„Ù…Ø·Ø§Ø±", "Ø§Ù„Ù…ØªØ±Ùˆ", "Ø§Ù„Ø³ÙŠÙ†Ù…Ø§", "Ø§Ù„Ù†Ø§Ø¯ÙŠ", "Ø§Ù„Ù‚Ù‡ÙˆØ©", "Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©", "Ø§Ù„Ø¨ÙŠØª", "Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª"
            ],
            "Ø£ÙÙ„Ø§Ù… ÙˆÙ…Ø³Ù„Ø³Ù„Ø§Øª": [
                "Ø§Ù„ÙƒÙŠÙ", "Ø§Ù„Ø¹Ø§Ø±", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø£Ø¨ÙŠØ¶", "Ø§Ù„ÙÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ù‚", "Ø¹Ø³Ù„ Ø£Ø³ÙˆØ¯", "Ø§Ù„Ù†Ø§Ø¸Ø±", "ØµØ¹ÙŠØ¯ÙŠ ÙÙŠ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠØ©", "Ù‡Ù…Ø§Ù… ÙÙŠ Ø£Ù…Ø³ØªØ±Ø¯Ø§Ù…", "Ø§Ù„Ù„Ù…Ø¨ÙŠ", "Ø§Ù„Ù„ÙŠ Ø¨Ø§Ù„ÙŠ Ø¨Ø§Ù„Ùƒ",
                "Ø¬Ø¹ÙØ± Ø§Ù„Ø¹Ù…Ø¯Ø©", "Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø©", "Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±", "Ø§Ù„ÙƒØ¨ÙŠØ± Ø£ÙˆÙŠ", "Ù…ÙˆØ¶ÙˆØ¹ Ø¹Ø§Ø¦Ù„ÙŠ", "Ù…Ø§ ÙˆØ±Ø§Ø¡ Ø§Ù„Ø·Ø¨ÙŠØ¹Ø©", "Ø§Ù„Ù„Ø¹Ø¨Ø©", "Ø¨Ù€ 100 ÙˆØ´", "ÙØ±Ù‚Ø© Ù†Ø§Ø¬ÙŠ Ø¹Ø·Ø§ Ø§Ù„Ù„Ù‡", "Ø°Ø¦Ø§Ø¨ Ø§Ù„Ø¬Ø¨Ù„"
            ],
            "Ø­ÙŠÙˆØ§Ù†Ø§Øª": [
                "Ø£Ø³Ø¯", "ÙÙŠÙ„", "Ø²Ø±Ø§ÙØ©", "ÙƒÙ„Ø¨", "Ù‚Ø·Ø©", "Ø­Ù…Ø§Ø±", "Ø­ØµØ§Ù†", "Ø¬Ø§Ù…ÙˆØ³Ø©", "Ø¨Ù‚Ø±Ø©", "Ø®Ø±ÙˆÙ",
                "Ù†Ø³Ø±", "ØµÙ‚Ø±", "Ø¨ØºØ¨Ø§Ù†", "ØªÙ…Ø³Ø§Ø­", "ØªØ¹ÙŠÙŠØ§Ù†", "ÙØ§Ø±", "ØµØ±ØµØ§Ø±", "Ù†Ù…Ù„Ø©", "Ø¯Ø¨Ø§Ù†Ø©", "Ù†Ø§Ù…ÙˆØ³Ø©"
            ]
        };

        const STORAGE_KEY = "batal_tarees_state";
        const EXPIRY_TIME = 5 * 60 * 1000; // 5 minutes

        const App = () => {
            // --- STATE ---
            const [gameState, setGameState] = useState({
                phase: 'WELCOME', // WELCOME, SETUP, CATEGORY, ROLE_ASSIGN, ROLE_REVEAL, GAME_LOOP, VOTING, REVEAL_RESULT, SPY_GUESS, END
                players: [],
                category: '',
                secretWord: '',
                spyIndex: -1,
                currentPlayerIndex: 0, // For turning cards
                startTime: 0,
                votes: {}, // playerId -> targetId
                voteResult: null, // who was voted out
                spyGuessedCorrectly: false,
                decoyWords: []
            });

            // --- LOCAL STORAGE LOGIC ---
            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        const now = Date.now();
                        // Check if data is fresh (less than 5 mins old)
                        if (now - parsed.timestamp < EXPIRY_TIME) {
                            setGameState(parsed.data);
                        } else {
                            localStorage.removeItem(STORAGE_KEY);
                        }
                    } catch (e) {
                        console.error("Save file corrupted");
                    }
                }
            }, []);

            useEffect(() => {
                if (gameState.phase !== 'WELCOME') {
                    const dataToSave = {
                        data: gameState,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                }
            }, [gameState]);

            // --- ACTIONS ---

            const startGame = (names) => {
                if (names.length < 3) {
                    alert("Ù„Ø§Ø²Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 3 Ù„Ø¹ÙŠØ¨Ø© ÙŠØ§ ØµØ§Ø­Ø¨ÙŠ");
                    return;
                }
                setGameState(prev => ({
                    ...prev,
                    phase: 'CATEGORY',
                    players: names.map((n, i) => ({ id: i, name: n })),
                    votes: {}
                }));
            };

            const selectCategory = (cat) => {
                const words = GAME_DATA[cat];
                const secret = words[Math.floor(Math.random() * words.length)];
                
                // Select Spy
                const spyIdx = Math.floor(Math.random() * gameState.players.length);

                // Prepare decoys for the end game (Spy Guess)
                const otherWords = words.filter(w => w !== secret);
                const shuffledOthers = otherWords.sort(() => 0.5 - Math.random()).slice(0, 3);
                const decoys = [secret, ...shuffledOthers].sort(() => 0.5 - Math.random());

                setGameState(prev => ({
                    ...prev,
                    phase: 'ROLE_REVEAL',
                    category: cat,
                    secretWord: secret,
                    spyIndex: spyIdx,
                    currentPlayerIndex: 0,
                    decoyWords: decoys,
                    startTime: Date.now() // Reset timer relative to game logic if needed
                }));
            };

            const nextPlayerReveal = () => {
                if (gameState.currentPlayerIndex < gameState.players.length - 1) {
                    setGameState(prev => ({ ...prev, currentPlayerIndex: prev.currentPlayerIndex + 1 }));
                } else {
                    setGameState(prev => ({ ...prev, phase: 'GAME_LOOP' }));
                }
            };

            const goToVoting = () => {
                setGameState(prev => ({ ...prev, phase: 'VOTING' }));
            };

            const castVote = (voterId, suspectId) => {
                setGameState(prev => {
                    const newVotes = { ...prev.votes, [voterId]: suspectId };
                    
                    // If everyone voted
                    if (Object.keys(newVotes).length === prev.players.length) {
                        // Calculate result
                        const voteCounts = {};
                        Object.values(newVotes).forEach(id => {
                            voteCounts[id] = (voteCounts[id] || 0) + 1;
                        });
                        
                        // Find who got the most votes
                        let maxVotes = -1;
                        let suspect = null;
                        
                        Object.entries(voteCounts).forEach(([id, count]) => {
                            if (count > maxVotes) {
                                maxVotes = count;
                                suspect = parseInt(id);
                            }
                        });

                        // 1 second delay for dramatic effect handled in component
                        setTimeout(() => {
                            setGameState(p => ({ ...p, phase: 'REVEAL_RESULT', voteResult: suspect }));
                        }, 500);

                        return { ...prev, votes: newVotes };
                    }
                    
                    return { ...prev, votes: newVotes };
                });
            };

            const handleSpyGuess = (word) => {
                const isCorrect = word === gameState.secretWord;
                setGameState(prev => ({
                    ...prev,
                    phase: 'END',
                    spyGuessedCorrectly: isCorrect
                }));
            };

            const resetGame = () => {
                localStorage.removeItem(STORAGE_KEY);
                setGameState({
                    phase: 'WELCOME',
                    players: [],
                    category: '',
                    secretWord: '',
                    spyIndex: -1,
                    currentPlayerIndex: 0,
                    startTime: 0,
                    votes: {},
                    voteResult: null,
                    spyGuessedCorrectly: false,
                    decoyWords: []
                });
            };

            const restartSamePlayers = () => {
                setGameState(prev => ({
                    phase: 'CATEGORY',
                    players: prev.players,
                    category: '',
                    secretWord: '',
                    spyIndex: -1,
                    currentPlayerIndex: 0,
                    startTime: 0,
                    votes: {},
                    voteResult: null,
                    spyGuessedCorrectly: false,
                    decoyWords: []
                }));
            };

            // --- RENDER HELPERS ---
            
            const renderPhase = () => {
                switch(gameState.phase) {
                    case 'WELCOME': return <WelcomeScreen onStart={() => setGameState(p => ({...p, phase: 'SETUP'}))} />;
                    case 'SETUP': return <SetupScreen onStart={startGame} />;
                    case 'CATEGORY': return <CategoryScreen categories={Object.keys(GAME_DATA)} onSelect={selectCategory} />;
                    case 'ROLE_REVEAL': 
                        return <RoleRevealScreen 
                                player={gameState.players[gameState.currentPlayerIndex]} 
                                isSpy={gameState.currentPlayerIndex === gameState.spyIndex}
                                secretWord={gameState.secretWord}
                                category={gameState.category}
                                onNext={nextPlayerReveal}
                                isLast={gameState.currentPlayerIndex === gameState.players.length - 1}
                               />;
                    case 'GAME_LOOP': return <GameLoopScreen onVote={goToVoting} category={gameState.category} />;
                    case 'VOTING': return <VotingScreen players={gameState.players} votes={gameState.votes} onVote={castVote} />;
                    case 'REVEAL_RESULT': 
                        return <RevealResultScreen 
                                players={gameState.players} 
                                spyIndex={gameState.spyIndex} 
                                voteResult={gameState.voteResult}
                                onNext={() => setGameState(p => ({...p, phase: 'SPY_GUESS'}))}
                               />;
                    case 'SPY_GUESS':
                        return <SpyGuessScreen 
                                spyName={gameState.players[gameState.spyIndex].name}
                                options={gameState.decoyWords}
                                onGuess={handleSpyGuess}
                               />;
                    case 'END':
                        return <EndScreen 
                                state={gameState}
                                onRestart={restartSamePlayers}
                                onHome={resetGame}
                               />;
                    default: return <div>Loading...</div>;
                }
            };

            return (
                <div className="app-container">
                    <div className="flex-grow p-4 max-w-md mx-auto w-full relative">
                        {renderPhase()}
                    </div>
                    
                    <footer className="p-4 text-center text-slate-500 text-xs font-semibold bg-slate-900/90 backdrop-blur border-t border-slate-800">
                        <p>Â© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¯Ù‰ HOMOS</p>
                    </footer>
                </div>
            );
        };

        // --- COMPONENTS ---

        const WelcomeScreen = ({ onStart }) => (
            <div className="flex flex-col items-center justify-center h-full pt-20 animate-pop">
                <div className="w-24 h-24 bg-red-600 rounded-full flex items-center justify-center mb-6 shadow-red-900/50 shadow-lg">
                    <EyeOff size={48} className="text-white" />
                </div>
                <h1 className="text-5xl font-extrabold mb-2 text-center text-red-500 tracking-tight">Ø¨Ø·Ù„ ØªØ¹Ø±ÙŠØµ</h1>
                <p className="text-slate-400 mb-12 text-lg">Ù…ÙŠÙ† ÙÙŠÙ†Ø§ Ø§Ù„Ø¹Ø±ØµØŸ</p>
                
                <button onClick={onStart} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-8 rounded-2xl shadow-lg transform transition active:scale-95 text-xl flex items-center justify-center gap-2">
                    <Play size={24} fill="currentColor" />
                    <span>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</span>
                </button>
            </div>
        );

        const SetupScreen = ({ onStart }) => {
            const [text, setText] = useState("");
            
            const handleSubmit = () => {
                const names = text.split('\n').map(n => n.trim()).filter(n => n.length > 0);
                onStart(names);
            };

            return (
                <div className="animate-pop h-full flex flex-col">
                    <h2 className="text-2xl font-bold mb-6 text-center text-red-400">Ø³Ø¬Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù„Ø¹ÙŠØ¨Ø©</h2>
                    <div className="flex-grow">
                        <textarea 
                            className="w-full h-64 bg-slate-800 border-2 border-slate-700 rounded-xl p-4 text-white text-lg focus:border-red-500 focus:outline-none placeholder-slate-500"
                            placeholder={"Ø§ÙƒØªØ¨ ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø±...\nØ£Ø­Ù…Ø¯\nÙ…Ø­Ù…Ø¯\nÙ…Ø­Ù…ÙˆØ¯"}
                            value={text}
                            onChange={(e) => setText(e.target.value)}
                        ></textarea>
                        <p className="text-sm text-slate-500 mt-2 text-center">Ù„Ø§Ø²Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 3 Ù„Ø¹ÙŠØ¨Ø©</p>
                    </div>
                    <button onClick={handleSubmit} className="w-full bg-slate-100 text-slate-900 font-bold py-4 rounded-xl shadow-lg mt-4 text-xl">
                        Ø§Ù„ØªØ§Ù„ÙŠ
                    </button>
                </div>
            );
        };

        const CategoryScreen = ({ categories, onSelect }) => (
            <div className="animate-pop">
                <h2 className="text-2xl font-bold mb-6 text-center text-yellow-400">Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</h2>
                <div className="grid grid-cols-2 gap-4">
                    {categories.map(cat => (
                        <button 
                            key={cat}
                            onClick={() => onSelect(cat)}
                            className="aspect-square bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-2xl p-4 flex flex-col items-center justify-center gap-2 transition active:scale-95"
                        >
                            <span className="text-3xl">
                                {cat === "Ø£ÙƒÙ„Ø§Øª Ù…ØµØ±ÙŠØ©" ? "ğŸ”" : 
                                 cat === "Ù…Ù„Ø§Ø¨Ø³" ? "ğŸ‘•" :
                                 cat === "Ù…Ø´Ø±ÙˆØ¨Ø§Øª" ? "â˜•" :
                                 cat === "Ù„Ø§Ø¹ÙŠØ¨Ø© ÙƒÙˆØ±Ø©" ? "âš½" :
                                 cat === "Ø£Ù…Ø§ÙƒÙ†" ? "ğŸ›ï¸" :
                                 cat === "Ø­ÙŠÙˆØ§Ù†Ø§Øª" ? "ğŸ¦" : "ğŸ¬"}
                            </span>
                            <span className="font-bold text-lg text-center">{cat}</span>
                        </button>
                    ))}
                </div>
            </div>
        );

        const RoleRevealScreen = ({ player, isSpy, secretWord, category, onNext, isLast }) => {
            const [revealed, setRevealed] = useState(false);

            // Reset revealed state when player changes
            useEffect(() => {
                setRevealed(false);
            }, [player]);

            return (
                <div className="h-full flex flex-col items-center justify-center animate-pop">
                    <div className="w-full max-w-sm glass-card rounded-3xl p-8 text-center relative overflow-hidden">
                        
                        <div className="mb-6">
                            <h3 className="text-slate-400 text-lg mb-2">Ø§Ù„Ø¯ÙˆØ± Ø¹Ù„Ù‰</h3>
                            <h2 className="text-4xl font-bold text-white">{player.name}</h2>
                        </div>

                        {!revealed ? (
                            <button 
                                onClick={() => setRevealed(true)}
                                className="w-full aspect-square rounded-full bg-red-600/20 border-4 border-red-500 flex flex-col items-center justify-center gap-4 animate-pulse active:bg-red-600/40 transition"
                            >
                                <Eye size={48} className="text-red-500" />
                                <span className="text-xl font-bold text-red-100">Ø¯ÙˆØ³ Ø¹Ø´Ø§Ù† ØªØ´ÙˆÙ Ø¯ÙˆØ±Ùƒ</span>
                            </button>
                        ) : (
                            <div className="flex flex-col items-center animate-pop">
                                {isSpy ? (
                                    <>
                                        <div className="w-32 h-32 bg-red-600 rounded-full flex items-center justify-center mb-4">
                                            <EyeOff size={64} className="text-white" />
                                        </div>
                                        <h2 className="text-3xl font-black text-red-500 mb-2">Ø£Ù†Øª Ø§Ù„Ø¹Ø±Øµ!</h2>
                                        <p className="text-slate-300 mb-6">Ø­Ø§ÙˆÙ„ ØªØ¹Ø±Ù Ø¥Ø­Ù†Ø§ Ø¨Ù†ØªÙƒÙ„Ù… Ø¹Ù† Ø¥ÙŠÙ‡ Ù…Ù† ØºÙŠØ± Ù…Ø§ ØªØªÙƒØ´Ù.</p>
                                    </>
                                ) : (
                                    <>
                                        <div className="w-32 h-32 bg-green-600 rounded-full flex items-center justify-center mb-4">
                                            <CheckCircle size={64} className="text-white" />
                                        </div>
                                        <h2 className="text-3xl font-black text-green-500 mb-2">Ù…ÙˆØ§Ø·Ù† Ø´Ø±ÙŠÙ</h2>
                                        <div className="bg-slate-800 p-4 rounded-xl w-full mb-2">
                                            <p className="text-slate-400 text-sm">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</p>
                                            <p className="text-xl font-bold text-yellow-400">{category}</p>
                                        </div>
                                        <div className="bg-slate-800 p-4 rounded-xl w-full mb-6">
                                            <p className="text-slate-400 text-sm">Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ©</p>
                                            <p className="text-2xl font-bold text-white">{secretWord}</p>
                                        </div>
                                    </>
                                )}
                                
                                <button 
                                    onClick={onNext}
                                    className="w-full bg-white text-slate-900 font-bold py-3 rounded-xl hover:bg-slate-200"
                                >
                                    {isLast ? "ÙŠÙ„Ø§ Ù†Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨" : "ØªÙ…Ø§Ù…ØŒ Ù‡Ø§Øª Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡"}
                                </button>
                            </div>
                        )}
                    </div>
                    {!revealed && (
                        <p className="mt-8 text-slate-500 text-sm text-center px-8">
                            Ø®Ø¨ÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ¯ÙˆØ³ Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±Ø§Ø± Ø¹Ø´Ø§Ù† ØªØ¹Ø±Ù Ø¯ÙˆØ±Ùƒ ÙˆÙ…Ø­Ø¯Ø´ ÙŠØ´ÙˆÙ ØºÙŠØ±Ùƒ.
                        </p>
                    )}
                </div>
            );
        };

        const GameLoopScreen = ({ onVote, category }) => {
            const [time, setTime] = useState(0);

            useEffect(() => {
                const interval = setInterval(() => {
                    setTime(t => t + 1);
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m}:${s < 10 ? '0' : ''}${s}`;
            };

            return (
                <div className="h-full flex flex-col items-center pt-10 animate-pop">
                    <div className="text-center mb-10">
                        <p className="text-slate-400 mb-2">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</p>
                        <h2 className="text-3xl font-bold text-yellow-400">{category}</h2>
                    </div>

                    <div className="w-48 h-48 rounded-full border-8 border-slate-700 flex flex-col items-center justify-center mb-12 shadow-[0_0_30px_rgba(255,0,0,0.1)]">
                        <Timer size={40} className="text-slate-500 mb-2" />
                        <span className="text-5xl font-mono font-bold text-white">{formatTime(time)}</span>
                    </div>

                    <div className="w-full mt-auto mb-8 px-4">
                        <button 
                            onClick={onVote}
                            className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-6 px-8 rounded-3xl shadow-lg transform transition active:scale-95 text-2xl border-b-4 border-red-800"
                        >
                            Ø¹Ø±ÙÙ†Ø§ Ù…ÙŠÙ† Ø§Ù„Ø¹Ø±Øµ!
                        </button>
                        <p className="text-center text-slate-500 mt-4 text-sm">Ø¯ÙˆØ³ Ù‡Ù†Ø§ Ù„Ù…Ø§ ØªØ´ÙƒÙˆØ§ ÙÙŠ Ø­Ø¯ Ø£Ùˆ Ø§Ù„ÙˆÙ‚Øª ÙŠØ®Ù„Øµ</p>
                    </div>
                </div>
            );
        };

        const VotingScreen = ({ players, votes, onVote }) => {
            // Find first player who hasn't voted
            const currentVoterId = players.find(p => !votes[p.id])?.id;
            
            // If everyone voted, we wait for parent to switch phase (logic handled in castVote)
            if (currentVoterId === undefined) return <div className="flex items-center justify-center h-full"><span className="text-2xl animate-pulse">Ø¬Ø§Ø±ÙŠ ÙØ±Ø² Ø§Ù„Ø£ØµÙˆØ§Øª...</span></div>;

            const currentVoter = players.find(p => p.id === currentVoterId);

            return (
                <div className="h-full flex flex-col pt-10 animate-pop">
                    <div className="text-center mb-8">
                        <h3 className="text-slate-400 mb-1">Ø¯ÙˆØ±</h3>
                        <h2 className="text-3xl font-bold text-white">{currentVoter.name}</h2>
                        <p className="text-red-400 mt-2 font-bold">Ø´Ø§ÙƒÙƒ ÙÙŠ Ù…ÙŠÙ†ØŸ</p>
                    </div>

                    <div className="grid grid-cols-1 gap-3 overflow-y-auto pb-4">
                        {players.map(p => {
                            // Can't vote for self
                            if (p.id === currentVoterId) return null;
                            return (
                                <button
                                    key={p.id}
                                    onClick={() => onVote(currentVoterId, p.id)}
                                    className="bg-slate-800 p-4 rounded-xl flex items-center justify-between hover:bg-slate-700 border border-slate-700"
                                >
                                    <span className="font-bold text-lg">{p.name}</span>
                                    <div className="w-8 h-8 rounded-full bg-slate-900 border border-slate-600 flex items-center justify-center">?</div>
                                </button>
                            )
                        })}
                    </div>
                </div>
            );
        };

        const RevealResultScreen = ({ players, spyIndex, voteResult, onNext }) => {
            const [countdown, setCountdown] = useState(3);
            const [revealed, setRevealed] = useState(false);

            useEffect(() => {
                if (countdown > 0) {
                    const timer = setTimeout(() => setCountdown(c => c - 1), 1000);
                    return () => clearTimeout(timer);
                } else {
                    setRevealed(true);
                }
            }, [countdown]);

            const spyName = players[spyIndex].name;
            const votedName = players.find(p => p.id === voteResult)?.name;
            const caught = voteResult === spyIndex;

            if (!revealed) {
                return (
                    <div className="h-full flex flex-col items-center justify-center">
                        <div className="text-9xl font-black text-red-600 animate-bounce">
                            {countdown}
                        </div>
                        <p className="mt-8 text-xl text-slate-400">Ù…ÙŠÙ† Ø§Ù„Ø¹Ø±Øµ...</p>
                    </div>
                );
            }

            return (
                <div className="h-full flex flex-col items-center justify-center animate-pop text-center">
                    <h2 className="text-xl text-slate-400 mb-2">Ø§Ù„Ø¹Ø±Øµ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù‡Ùˆ</h2>
                    <h1 className="text-5xl font-black text-red-500 mb-8">{spyName}</h1>

                    <div className="glass-card p-6 rounded-2xl w-full mb-8">
                        <h3 className="text-lg text-slate-300 mb-2">Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØµÙˆÙŠØª</h3>
                        <p className="text-xl font-bold">
                            Ø§Ù„Ù†Ø§Ø³ Ø´ÙƒØª ÙÙŠ <span className="text-yellow-400">{votedName}</span>
                        </p>
                        <div className={`mt-4 text-2xl font-bold ${caught ? 'text-green-400' : 'text-red-400'}`}>
                            {caught ? "Ù‚ÙØ´ØªÙˆÙ‡! ğŸ‘" : "Ø§Ù„Ø¹Ø±Øµ Ù‡Ø±Ø¨! ğŸƒ"}
                        </div>
                    </div>

                    <button 
                        onClick={onNext}
                        className="w-full bg-white text-slate-900 font-bold py-4 rounded-xl shadow-lg text-lg"
                    >
                        Ø§Ù„ØªØ§Ù„ÙŠ
                    </button>
                </div>
            );
        };

        const SpyGuessScreen = ({ spyName, options, onGuess }) => (
            <div className="h-full flex flex-col animate-pop pt-8">
                <div className="text-center mb-8">
                    <h3 className="text-slate-400">ÙØ±ØµØ© Ø£Ø®ÙŠØ±Ø© Ù„Ù€</h3>
                    <h2 className="text-3xl font-bold text-red-500 mb-4">{spyName}</h2>
                    <p className="text-white text-xl font-bold bg-slate-800 py-2 px-4 rounded-lg inline-block">
                        Ù‚ÙˆÙ„Ù†Ø§ Ø§Ù„ÙƒÙ„Ù…Ø© ÙƒØ§Ù†Øª Ø¥ÙŠÙ‡ØŸ
                    </p>
                </div>

                <div className="grid grid-cols-1 gap-4">
                    {options.map((word, idx) => (
                        <button
                            key={idx}
                            onClick={() => onGuess(word)}
                            className="bg-slate-700 hover:bg-slate-600 border border-slate-500 text-white font-bold py-4 px-6 rounded-xl text-xl transition active:scale-95"
                        >
                            {word}
                        </button>
                    ))}
                </div>
            </div>
        );

        const EndScreen = ({ state, onRestart, onHome }) => {
            // Logic for winner:
            // 1. If Spy was NOT caught in voting -> Spy Wins.
            // 2. If Spy WAS caught, but guessed word correctly -> Spy Wins.
            // 3. If Spy WAS caught and guessed WRONG -> Citizens Win.
            
            const spyCaught = state.voteResult === state.spyIndex;
            const spyGuessedRight = state.spyGuessedCorrectly;
            
            let spyWins = false;
            let title = "";
            let message = "";

            if (!spyCaught) {
                spyWins = true;
                title = "Ø§Ù„Ø¹Ø±Øµ ÙƒØ³Ø¨!";
                message = "Ù…Ø­Ø¯Ø´ Ø¹Ø±Ù ÙŠÙƒØ´ÙÙ‡ ÙˆØ®Ù„Ø¹ Ù…Ù†ÙƒÙ….";
            } else if (spyGuessedRight) {
                spyWins = true;
                title = "Ø§Ù„Ø¹Ø±Øµ ÙƒØ³Ø¨!";
                message = "Ù‚ÙØ´ØªÙˆÙ‡ØŒ Ø¨Ø³ Ù‡Ùˆ Ø¹Ø±Ù Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ©!";
            } else {
                spyWins = false;
                title = "Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ† ÙƒØ³Ø¨ÙˆØ§!";
                message = "Ù‚ÙØ´ØªÙˆÙ‡ ÙˆÙ…Ø¹Ø±ÙØ´ Ø§Ù„ÙƒÙ„Ù…Ø©. ØªØ­ÙŠØ§ Ù…ØµØ±!";
            }

            return (
                <div className="h-full flex flex-col items-center justify-center animate-pop text-center">
                    <div className="mb-6">
                        {spyWins ? (
                            <EyeOff size={80} className="text-red-500 mx-auto" />
                        ) : (
                            <Trophy size={80} className="text-yellow-400 mx-auto" />
                        )}
                    </div>
                    
                    <h1 className={`text-4xl font-black mb-4 ${spyWins ? 'text-red-500' : 'text-yellow-400'}`}>
                        {title}
                    </h1>
                    <p className="text-xl text-slate-300 mb-8 max-w-xs mx-auto leading-relaxed">
                        {message}
                    </p>

                    <div className="bg-slate-800 p-6 rounded-2xl w-full mb-8 border border-slate-700">
                        <p className="text-slate-400 text-sm mb-1">Ø§Ù„ÙƒÙ„Ù…Ø© ÙƒØ§Ù†Øª</p>
                        <p className="text-3xl font-bold text-white">{state.secretWord}</p>
                    </div>

                    <div className="w-full space-y-3">
                        <button 
                            onClick={onRestart}
                            className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2"
                        >
                            <RefreshCcw size={20} />
                            <span>Ù„Ø¹Ø¨Ø© ÙƒÙ…Ø§Ù† Ø¨Ù†ÙØ³ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</span>
                        </button>
                        <button 
                            onClick={onHome}
                            className="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 rounded-xl"
                        >
                            Ø®Ø±ÙˆØ¬
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

