<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø¨Ø·Ù„ ØªØ¹Ø±ÙŠØµ ğŸ¤¡</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¤¡</text></svg>">

<style>
:root{
--bg:#020617;
--card:#0f172a;
--green:#22c55e;
--red:#ef4444;
--text:#f8fafc;
}
*{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont;-webkit-tap-highlight-color:transparent;}
body{margin:0;background:linear-gradient(135deg,#020617,#0f172a);color:var(--text);min-height:100vh;display:flex;justify-content:center;align-items:center;}
.app{width:100%;max-width:420px;padding:15px;}
.card{background:var(--card);border-radius:22px;padding:20px;box-shadow:0 20px 40px rgba(0,0,0,.6);animation:fade .4s ease;}
h1{text-align:center;margin:0 0 10px;}
p{text-align:center;opacity:.8;}
input,button{width:100%;padding:14px;margin-top:12px;border-radius:14px;border:none;font-size:16px;}
input{background:#020617;color:white;border:1px solid #334155;}
button{background:var(--green);font-weight:bold;cursor:pointer;}
button.red{background:var(--red);color:white;}
.room-code{text-align:center;font-size:24px;letter-spacing:4px;background:#020617;padding:12px;border-radius:14px;margin:10px 0;}
.player{background:#020617;padding:10px;border-radius:12px;margin-top:6px;text-align:center;}
.vote{margin-top:8px;}
audio{width:100%;margin-top:10px;border-radius:10px;}
@keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>

<body>
<div class="app">
<div class="card" id="screen">
<h1>Ø¨Ø·Ù„ ØªØ¹Ø±ÙŠØµ ğŸ¤¡</h1>
<p>Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ù„ÙŠ ØªÙØ¶Ø­ ØµØ­Ø§Ø¨Ùƒ</p>

<input id="nameInput" placeholder="Ø§Ø³Ù…Ùƒ ÙŠØ§ Ù†Ø¬Ù…">
<button onclick="createRoom()">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>

<input id="roomInput" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©">
<button onclick="joinRoom()">Ø¯Ø®ÙˆÙ„ Ø§Ù„ØºØ±ÙØ©</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyBPLxoVwM80jzFHwxfw59BjIQCs5xfN2kc",
authDomain:"batl-b9a34.firebaseapp.com",
projectId:"batl-b9a34",
storageBucket:"batl-b9a34.firebasestorage.app",
messagingSenderId:"878273587838",
appId:"1:878273587838:web:03bb355473cd652563c62f"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const words=[
"Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ","Ø·Ø§Ø¨ÙˆØ± Ø§Ù„Ø¹ÙŠØ´","ÙØ±Ø­ Ø¨Ù„Ø¯ÙŠ","Ù‚Ø¹Ø¯Ø© Ù‚Ù‡ÙˆØ©",
"Ø§Ù…ØªØ­Ø§Ù† Ù…ÙØ§Ø¬Ø¦","Ø§Ù„Ù†Øª ÙØµÙ„","Ø§Ù„Ù‚Ø¨Ø¶ Ø¢Ø®Ø± Ø§Ù„Ø´Ù‡Ø±",
"ÙƒØ´Ùƒ Ø³Ø¬Ø§ÙŠØ±","Ø³Ù†ØªØ± Ø¯Ø±ÙˆØ³","ÙƒÙˆØ¨Ø§ÙŠØ© Ø´Ø§ÙŠ"
];

let roomCode="";
let playerName="";
let localStream=null;

// ==========================
// ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ ÙØ±ÙŠØ¯ Ù„Ù„ØºØ±ÙØ©
// ==========================
async function genUniqueCode(){
  let code, exists=true;
  while(exists){
    code=Math.random().toString(36).substring(2,6).toUpperCase();
    const snap=await getDoc(doc(db,"rooms",code));
    if(!snap.exists()) exists=false;
  }
  return code;
}

// ==========================
// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©
// ==========================
window.createRoom=async()=>{
  playerName=nameInput.value.trim();
  if(!playerName) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ");

  roomCode = await genUniqueCode(); // ÙƒÙˆØ¯ ÙØ±ÙŠØ¯
  const word = words[Math.floor(Math.random()*words.length)];

  await setDoc(doc(db,"rooms",roomCode),{
    status:"waiting",
    word,
    spy:"",
    players:{[playerName]:{name:playerName,voted:false}},
    votes:{}
  });

  openRoom();
};

// ==========================
// Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©
// ==========================
window.joinRoom=async()=>{
  playerName=nameInput.value.trim();
  roomCode=roomInput.value.trim().toUpperCase();
  if(!playerName||!roomCode) return alert("ÙƒÙ…Ù‘Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

  const ref=doc(db,"rooms",roomCode);
  const snap=await getDoc(ref);
  if(!snap.exists()) return alert("Ø§Ù„ØºØ±ÙØ© Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©");

  const data=snap.data();
  if(data.players[playerName]) return alert("Ø§Ù„Ø§Ø³Ù… Ø¯Ù‡ Ù…Ø³ØªØ®Ø¯Ù…");

  data.players[playerName]={name:playerName,voted:false};
  await setDoc(ref,data);
  openRoom();
};

// ==========================
// ÙØªØ­ Ø§Ù„ØºØ±ÙØ©
// ==========================
function openRoom(){
  screen.innerHTML=`
    <h1>Ø§Ù„ØºØ±ÙØ© ğŸ”¥</h1>
    <div class="room-code">${roomCode}</div>
    <button onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
    <h3>Ø§Ù„Ø´Ø§Øª Ø§Ù„ØµÙˆØªÙŠ ğŸ™ï¸</h3>
    <button onclick="startAudio()">ÙØªØ­ Ø§Ù„Ù…Ø§ÙŠÙƒ</button>
    <div id="players"></div>
  `;

  onSnapshot(doc(db,"rooms",roomCode),snap=>{
    const data=snap.data();
    const div=document.getElementById("players");
    div.innerHTML="";
    Object.keys(data.players).forEach(p=>{
      div.innerHTML+=`<div class="player">ğŸ˜‚ ${p}</div>`;
    });
  });
}

// ==========================
// Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© + ØªÙˆØ²ÙŠØ¹ Ø¬Ø§Ø³ÙˆØ³
// ==========================
window.startGame=async()=>{
  const ref=doc(db,"rooms",roomCode);
  const snap=await getDoc(ref);
  const players=Object.keys(snap.data().players);
  const spyPlayer=players[Math.floor(Math.random()*players.length)];
  await updateDoc(ref,{spy:spyPlayer,status:"playing"});
  showRole();
};

// ==========================
// Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù„ÙƒÙ„Ù…Ø©
// ==========================
function showRole(){
  onSnapshot(doc(db,"rooms",roomCode),snap=>{
    const data=snap.data();
    if(data.status!=="playing") return;

    if(playerName===data.spy){
      screen.innerHTML=`
        <h1>ğŸ˜ˆ Ø§Ù†Øª Ø§Ù„Ø¬Ø§Ø³ÙˆØ³</h1>
        <p>Ø­Ø§ÙˆÙ„ ØªØ¹Ø¯ÙŠ ÙˆÙ…ØªÙØ¶Ø­Ø´ Ù†ÙØ³Ùƒ</p>
        <button onclick="goVote()">Ø±ÙˆØ­ ØµÙˆÙ‘Øª</button>
      `;
    }else{
      screen.innerHTML=`
        <h1>Ø§Ù„ÙƒÙ„Ù…Ø© ğŸ‘‡</h1>
        <div class="room-code">${data.word}</div>
        <button onclick="goVote()">Ø±ÙˆØ­ ØµÙˆÙ‘Øª</button>
      `;
    }
  });
}

// ==========================
// Ø§Ù„ØªØµÙˆÙŠØª
// ==========================
window.goVote=()=>{
  onSnapshot(doc(db,"rooms",roomCode),snap=>{
    const data=snap.data();
    screen.innerHTML="<h1>ØµÙˆÙ‘Øª ğŸ‘‡</h1>";
    Object.keys(data.players).forEach(p=>{
      if(p!==playerName){
        screen.innerHTML+=`<button class="vote red" onclick="vote('${p}')">${p}</button>`;
      }
    });
  });
};

window.vote=async(name)=>{
  const ref=doc(db,"rooms",roomCode);
  const snap=await getDoc(ref);
  const data=snap.data();
  data.votes[name]=(data.votes[name]||0)+1;
  await updateDoc(ref,{votes:data.votes});
  showResult();
};

function showResult(){
  onSnapshot(doc(db,"rooms",roomCode),snap=>{
    const data=snap.data();
    let max=0,loser="";
    for(let v in data.votes){
      if(data.votes[v]>max){max=data.votes[v];loser=v;}
    }
    screen.innerHTML=`
      <h1>Ø§Ù„Ù†ØªÙŠØ¬Ø© ğŸ˜‚</h1>
      <p>Ø£ÙƒØªØ± ÙˆØ§Ø­Ø¯ Ø§ØªØ´ØªÙ…: <b>${loser}</b></p>
      <p>${loser===data.spy?"Ø§ØªÙØ¶Ø­ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ ğŸ˜ˆ":"Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ ÙƒØ³Ø¨ ğŸ¤¡"}</p>
      <button onclick="location.reload()">Ø¥Ù„Ø¹Ø¨ ØªØ§Ù†ÙŠ</button>
    `;
  });
}

// ==========================
// WebRTC ØµÙˆØªÙŠ
// ==========================
async function startAudio(){
  if(localStream) return alert("Ø§Ù„Ù…ÙŠÙƒ Ø´ØºØ§Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ ğŸ˜");
  localStream = await navigator.mediaDevices.getUserMedia({audio:true});
  const audioElem=document.createElement("audio");
  audioElem.srcObject=localStream;
  audioElem.autoplay=true;
  audioElem.muted=true; // Ø§Ù„Ù…Ø§ÙŠÙƒ Ø§Ù„Ø´Ø®ØµÙŠ
  document.body.appendChild(audioElem);
  alert("Ø§Ù„Ù…ÙŠÙƒ Ø´ØºØ§Ù„ Ø¯Ù„ÙˆÙ‚ØªÙŠ ğŸ˜‚");
}

</script>
</body>
</html>
